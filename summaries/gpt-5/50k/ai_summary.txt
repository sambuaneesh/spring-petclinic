Comprehensive Architectural Summary — Spring PetClinic Monolith (Merged)

Overview
- Type: Monolithic Spring Boot 3.5.x web application (MVC + Thymeleaf) with a small JSON endpoint
- Purpose: Manage pet clinic data (owners, pets, visits, veterinarians, specialties)
- Layers and Patterns:
  - Presentation: Spring MVC controllers and Thymeleaf templates (server-side HTML), plus one JSON endpoint
  - Domain: JPA entities with validation
  - Data access: Spring Data JPA repositories
  - Cross-cutting: Caching via JCache (Caffeine), internationalization (i18n), Actuator, AOT/native image hints (GraalVM)
- Persistence: H2 in-memory by default; MySQL and PostgreSQL supported via profiles
- Deployment: Buildpacks-based container image; Docker Compose for DBs; Kubernetes manifests with Postgres via Service Binding

Bootstrapping and AOT/Native Image
- PetClinicApplication: Spring Boot main class
- PetClinicRuntimeHints: Registers GraalVM native image hints
  - Resources: db/* (SQL scripts), messages/* (i18n bundles), mysql-default-conf
  - Serialization: BaseEntity, Person, Vet
- AOT/Native image considerations: Some tests are disabled in AOT/Native modes

Core Domain Model (package highlights)
- Base classes (org.springframework.samples.petclinic.model)
  - BaseEntity: id (Integer, IDENTITY); isNew()
  - NamedEntity: name (String, @NotBlank)
  - Person: firstName, lastName (both @NotBlank)
- Owner domain (org.springframework.samples.petclinic.owner)
  - Owner (Entity owners): extends Person; address, city, telephone (@Pattern "\\d{10}"); one-to-many pets
    - pets: EAGER, cascade ALL, @JoinColumn(name="owner_id"), ordered by name
    - Domain helpers: getPet(name, ignoreNew), getPet(id), addPet(Pet), addVisit(petId, Visit)
  - Pet (Entity pets): extends NamedEntity; birthDate (LocalDate); relationships:
    - ManyToOne type (PetType)
    - OneToMany visits (EAGER, cascade ALL, @JoinColumn(name="pet_id"), ordered by date asc)
    - addVisit(Visit)
  - Visit (Entity visits): extends BaseEntity; date (defaults to now); description (@NotBlank)
  - PetType (Entity types): extends NamedEntity
- Vet domain (org.springframework.samples.petclinic.vet)
  - Vet (Entity vets): extends Person; ManyToMany specialties (EAGER) via join table vet_specialties
    - Helpers: getSpecialties (sorted by name), getNrOfSpecialties, addSpecialty
  - Specialty (Entity specialties): extends NamedEntity

Repositories and Data Access
- OwnerRepository: JpaRepository<Owner, Integer>
  - findByLastNameStartingWith(String, Pageable) -> Page<Owner>
  - findById(Integer) -> Optional<Owner>
  - save(Owner)
- PetTypeRepository: JpaRepository<PetType, Integer>
  - @Query findPetTypes() -> Collection<PetType>, sorted by name
- VetRepository: Spring Data Repository<Vet, Integer>
  - findAll() -> Collection<Vet> and findAll(Pageable) -> Page<Vet>
  - @Cacheable("vets"); @Transactional(readOnly = true)
- Transactions:
  - VetRepository methods explicitly read-only transactional
  - Other persistence operations use Spring Data defaults
- JPA settings:
  - spring.jpa.hibernate.ddl-auto=none (schema managed by SQL scripts)
  - spring.jpa.open-in-view=false (OSIV disabled; prevents lazy access after request thread; notable given EAGER mappings)

Web Layer (Controllers, Binding, Views)
- OwnerController
  - GET /owners/new -> owners/createOrUpdateOwnerForm.html
  - POST /owners/new -> create owner; redirects to /owners/{id}; flash “New Owner Created”
  - GET /owners/find -> owners/findOwners.html
  - GET /owners?lastName=&page= -> search; 5/page pagination
    - Empty lastName treated as wildcard ""
    - 0 results -> findOwners with field error lastName=notFound
    - 1 result -> redirect to owner details
    - >1 -> owners/ownersList.html
  - GET /owners/{ownerId} -> owners/ownerDetails.html (includes pets and visits; flash messages)
  - GET /owners/{ownerId}/edit -> owners/createOrUpdateOwnerForm.html
  - POST /owners/{ownerId}/edit -> update; redirects to /owners/{ownerId}; flash “Owner Values Updated”
    - Path/form id mismatch protection: detects mismatch; redirects back to edit with flash error
- PetController (base path /owners/{ownerId})
  - GET /owners/{ownerId}/pets/new -> pets/createOrUpdatePetForm.html; pet added to owner model; pet types populated
  - POST /owners/{ownerId}/pets/new -> validate and save via Owner cascade; redirect to owner details; flash “New Pet has been Added”
    - Validation: name required and unique within owner (error code "duplicate"); type required; birthDate required; invalid/future date -> typeMismatch.birthDate
  - GET /owners/{ownerId}/pets/{petId}/edit -> pets/createOrUpdatePetForm.html
  - POST /owners/{ownerId}/pets/{petId}/edit -> validate and update existing pet fields or add if not found; save owner; redirect; flash “Pet details has been edited”
- VisitController
  - GET /owners/{ownerId}/pets/{petId}/visits/new -> pets/createOrUpdateVisitForm.html; model contains owner, pet, and new visit linked to pet
  - POST /owners/{ownerId}/pets/{petId}/visits/new -> @Valid Visit; on success owner.addVisit(petId, visit); owners.save(owner); redirect; flash “Your visit has been booked”
  - Validation: description required; errors bound to model attribute "visit"
- VetController
  - GET /vets.html?page= -> vets/vetList.html; paginated (5/page); model attribute listVets
  - GET /vets -> JSON/XML Vets DTO; property "vetList" contains entries; cacheable repository access
- System controllers and web config (org.springframework.samples.petclinic.system)
  - WelcomeController: GET / -> “welcome.html”
  - CrashController: GET /oups -> throws RuntimeException to demonstrate error handling
    - Content negotiation: If Accept: application/json -> JSON error body includes timestamp, status, error, message, path; If Accept: text/html -> custom error page
  - WebConfiguration: i18n
    - SessionLocaleResolver default English
    - LocaleChangeInterceptor param "lang" registered via WebMvcConfigurer
- Binding and Validation utilities
  - Controllers use WebDataBinder to disallow binding of id fields (mass-assignment protection)
  - PetTypeFormatter: parse(String, Locale) -> PetType by name; print(PetType) -> name
  - PetValidator:
    - Validates name (required, not blank; duplicate within owner -> error code "duplicate")
    - Validates type (required, required when new)
    - Validates birthDate (required; invalid format -> typeMismatch; future dates rejected; in creation mapped as typeMismatch.birthDate)
  - Bean Validation via Hibernate Validator:
    - Example: Person.firstName must not be blank
    - Owner.telephone must match 10 digits

Views, Static Assets, and Theming
- Thymeleaf templates: owners, pets, visits, vets, fragments (layout, input/select fields), welcome, error
- i18n messages: messages/messages*.properties (locales: de, es, fa, ko, pt, ru, tr, en); templates use message keys
- i18n enforcement in tests:
  - Templates must not contain raw text outside th:text/th:utext with #{...}
  - All locale files must include all keys; messages_en.properties may be empty (fallback to base)
- Static assets:
  - WebJars for Bootstrap and FontAwesome
  - SCSS compiled to CSS via Maven profile "css" (libsass-maven-plugin)
  - Outputs served at /resources/css/petclinic.css; fonts under /resources/fonts (varela_roundregular, montserratregular)
  - Client loads: /resources/css/petclinic.css and /webjars/bootstrap/dist/js/bootstrap.bundle.min.js
  - Images referenced for mobile logo; responsive design and custom palette
- Static resource caching: Cache-Control max-age=12h

HTTP API Endpoints (summary)
- General
  - GET / -> home (welcome.html)
  - GET /oups -> triggers error (custom HTML or JSON error response)
- Owners
  - GET /owners/new; POST /owners/new; GET /owners/find; GET /owners?page={n}&lastName={prefix?}; GET /owners/{ownerId}; GET/POST /owners/{ownerId}/edit
- Pets (scoped under owner)
  - GET /owners/{ownerId}/pets/new; POST /owners/{ownerId}/pets/new
  - GET /owners/{ownerId}/pets/{petId}/edit; POST /owners/{ownerId}/pets/{petId}/edit
- Visits (scoped under owner and pet)
  - GET /owners/{ownerId}/pets/{petId}/visits/new; POST /owners/{ownerId}/pets/{petId}/visits/new
- Vets
  - GET /vets.html?page={n} (HTML list)
  - GET /vets (JSON/XML Vets DTO)
- Actuator (enabled)
  - All endpoints exposed at /actuator/*
  - Additional health probe aliases enabled: /livez and /readyz (see Kubernetes section)

Database Models, Schemas, and Initialization
- Entities and relationships
  - owners: id PK, first_name, last_name (case-insensitive index in H2/HSQL), address, city, telephone (10-digit validation)
  - pets: id PK, name, birth_date, type_id FK -> types.id, owner_id FK -> owners.id; index on name (and owner_id in Postgres)
  - types: id PK, name (indexed)
  - visits: id PK, pet_id FK -> pets.id, visit_date, description; index on pet_id
  - vets: id PK, first_name, last_name (indexed on last_name)
  - specialties: id PK, name (indexed)
  - vet_specialties: (vet_id FK -> vets.id, specialty_id FK -> specialties.id), unique composite key
- DB engines and scripts
  - H2 in-memory (default): schema.sql and data.sql under classpath db/h2/
  - HSQLDB (alternative for tests): scripts in db/hsqldb/
  - MySQL: scripts in db/mysql/ (data uses INSERT IGNORE), user.sql to create DB/user; profile spring.profiles.active=mysql
  - PostgreSQL: scripts in db/postgres/ (idempotent inserts); profile spring.profiles.active=postgres
- SQL DDL managed by scripts; Hibernate DDL auto disabled (none)

Caching
- JCache API with Caffeine backing; Cache name: "vets"
  - Applied to VetRepository.findAll() and findAll(Pageable)
  - Cache configuration via CacheConfiguration (@EnableCaching); statistics enabled (exposure depends on provider/JMX/Actuator)
- Behavior: repeated findAll() calls served from cache

Observability and Logging
- Spring Boot Actuator fully exposed under /actuator/*
- Kubernetes deployment sets management.endpoint.health.probes.add-additional-paths=true to expose /livez and /readyz
- Logging defaults: org.springframework=INFO

Configuration and Profiles
- application.properties (default)
  - Database init script locations parameterized by ${database} (e.g., db/h2/schema.sql, data.sql)
  - Default database=h2; Thymeleaf mode HTML; actuator exposure include=*
  - Static resources caching enabled
- application-mysql.properties
  - database=mysql; datasource url/user/password from env MYSQL_URL, MYSQL_USER, MYSQL_PASS with defaults (jdbc:mysql://localhost/petclinic, petclinic, petclinic)
  - spring.sql.init.mode=always
- application-postgres.properties
  - database=postgres; datasource url/user/password from POSTGRES_URL, POSTGRES_USER, POSTGRES_PASS
  - spring.sql.init.mode=always
- Environment variables of note
  - Profiles: spring.profiles.active [default|mysql|postgres]
  - MySQL: MYSQL_URL, MYSQL_USER, MYSQL_PASS
  - Postgres: POSTGRES_URL, POSTGRES_USER, POSTGRES_PASS
  - Kubernetes service binding: SERVICE_BINDING_ROOT=/bindings and a projected Secret of type servicebinding.io/postgresql providing host, port, database, username, password
  - SPRING_APPLICATION_JSON used to enable health probe additional paths

Build, Tooling, and Dependencies
- Build systems: Maven (primary) and Gradle (supported)
- Maven coordinates: org.springframework.samples:spring-petclinic:3.5.0-SNAPSHOT
- Spring Boot Maven Plugin with build-info
- Java 17 minimum
- AOT/Native: org.graalvm.buildtools:native-maven-plugin
- Code quality and reporting: spring-javaformat, checkstyle (NoHTTP), jacoco, cyclonedx SBOM, git-commit-id
- Web assets: webjars-locator-lite, bootstrap 5.3.6, font-awesome 4.7.0; SCSS compiled by libsass (Maven profile "css")
- Spring Boot starters: actuator, cache, data-jpa, web, validation, thymeleaf, test (scope), devtools (test scope)
- DB drivers: H2 (runtime), MySQL, PostgreSQL (runtime)
- Caching: javax.cache (JCache API), com.github.ben-manes.caffeine
- Testing: spring-boot-testcontainers, spring-boot-docker-compose, org.testcontainers (junit-jupiter, mysql), JUnit 5, Mockito
- Performance testing: JMeter plan (500 threads, 10 loops, 10s ramp-up, 300ms delay) covering home, static CSS/JS, vets (HTML), owner flows, pet creation, visit creation

Testing and Environments
- Web layer tests: @WebMvcTest with MockMvc covering OwnerController, PetController, VisitController, VetController, CrashController; validation and binding behavior validated
- Data layer tests: @DataJpaTest using H2 by default; MySQL via Testcontainers (image mysql:9.2 as specified); PostgreSQL via Spring Boot Docker Compose integration (service name "postgres")
- Integration tests: End-to-end flows against H2, MySQL (Testcontainers), PostgreSQL (Docker Compose)
- I18n tests: enforce no raw text in templates and parity across message bundles (except messages_en.properties)
- Performance tests: JMeter scripts fetch static assets and execute common flows with cookies enabled
- CI/CD (GitHub Actions):
  - Maven pipeline: ./mvnw -B verify with Java 17
  - Gradle pipeline: ./gradlew build with Java 17
  - Kubernetes workflow: creates KinD cluster; applies manifests in k8s/; waits for pods labeled app=demo-db and app=petclinic ready
- Dev environments:
  - Devcontainer: Ubuntu base; features Java 21 (oracle), azure-cli, docker-in-docker, gh-cli
  - Gitpod Dockerfile: Java 17 via SDKMAN; mounts .m2 and .gradle caches

Deployment and Operations
- Containerization: Buildpacks-based image build via Spring Boot; published image reference dsyer/petclinic (repo suggests custom build via build-image if needed)
- Docker Compose:
  - Services for mysql:9.2 and postgres:17.5 with standard env vars; ports exposed 3306/5432
- Kubernetes manifests (k8s/)
  - db.yml
    - Secret demo-db (type servicebinding.io/postgresql) with connection info (host, port, database, username, password)
    - Service demo-db (port 5432)
    - Deployment demo-db (postgres:17.5) with env from Secret
    - Probes: TCP readiness/liveness/startup on 5432
  - petclinic.yml
    - Service petclinic (NodePort; port 80 → container 8080)
    - Deployment petclinic (image dsyer/petclinic; replicas=1)
      - Env:
        - SPRING_PROFILES_ACTIVE=postgres
        - SERVICE_BINDING_ROOT=/bindings
        - SPRING_APPLICATION_JSON enabling additional health probe paths
      - Container port 8080 named "http"
      - Probes: liveness GET /livez; readiness GET /readyz
      - VolumeMount: /bindings/secret from projected Secret demo-db (readOnly)

Security
- No authentication or authorization configured

External Dependencies and Communication Patterns
- Relational databases via JDBC (HikariCP by Spring Boot)
- Caching is in-process via JCache with Caffeine backing; no external cache server
- No outbound HTTP/RPC or messaging; all features operate within single process
- Presentation primarily server-rendered HTML; one JSON endpoint (/vets)

Business Rules and Validation
- Binding restrictions: controllers disallow binding of id fields
- Owner telephone must be exactly 10 digits (validation)
- Owner search logic:
  - lastName prefix search; empty means wildcard
  - Cardinality outcomes: none -> error on lastName; one -> redirect; many -> list view
- Pet rules:
  - Name required and unique per owner (duplicate error code "duplicate")
  - Type required; for new instances also enforced
  - Birth date required and must not be in the future; invalid/future maps to typeMismatch.birthDate in creation
  - Edit merges fields into existing pet by id on owner before save
- Visit rules:
  - Visit created with current date by default; description required
  - Added via Owner.addVisit(petId, visit) with non-null checks and persisted by saving Owner aggregate
- Vets:
  - Vet list retrieval is cached for performance; read-heavy domain

Caching and Performance Considerations
- "vets" cache via JCache/Caffeine; @Cacheable on VetRepository.findAll() and pageable variant
- Cache statistics enabled (JCache-level; availability via JMX depends on provider/Actuator setup)
- Performance tests simulate realistic load including static assets and CRUD flows

Internationalization
- SessionLocaleResolver default EN; change locale via ?lang=xx (LocaleChangeInterceptor)
- All labels/messages sourced from message bundles
- Tests enforce no hard-coded text in templates and key parity across locales

Service Boundaries and Decomposition Considerations
- Current monolith is organized into cohesive domains with low controller-level coupling but a shared persistence model:
  - Owner Service candidate: owners, pets, visits, pet types; endpoints under /owners/**; strong aggregate relationships (Owner → Pet/Visit) with EAGER cascades
  - Vet Service candidate: vets, specialties; endpoints /vets.html (HTML) and /vets (JSON); read-mostly, cacheable, relatively independent
  - System/Edge: welcome, error handling, i18n, static assets aggregation
- Decomposition risks and constraints:
  - Strong JPA cascades and EAGER fetches imply tight coupling; would require refactoring to explicit service boundaries with asynchronous or REST interactions
  - Shared database schema couples domains; separation needs schema split (owners-pets-visits-types vs vets-specialties), data migration, and new APIs
  - UI templates are tightly bound to domain objects; a BFF/API composition layer or client-side composition may be needed post-split
  - Local in-memory cache ("vets") must be moved into the Vets service or handled at the edge if separated
  - OSIV is disabled; transactional boundaries must be respected in any service decomposition
- Potential interactions post-split:
  - Owners service fully owns pets, visits, and pet types; any cross-service references to pet types would need either duplication or a small reference data service/API
  - Vets service independently serves vet lists (HTML/JSON); UI composition could consume JSON from Vets service or keep server-rendered pages hosted by that service

Component Inventory (Java packages/classes)
- org.springframework.samples.petclinic
  - PetClinicApplication
  - PetClinicRuntimeHints
- org.springframework.samples.petclinic.model
  - BaseEntity, NamedEntity, Person
- org.springframework.samples.petclinic.owner
  - Entities: Owner, Pet, PetType, Visit
  - Repos/Formatters/Validation: OwnerRepository, PetTypeRepository, PetTypeFormatter, PetValidator
  - Web: OwnerController, PetController, VisitController
- org.springframework.samples.petclinic.vet
  - Entities: Vet, Specialty
  - Repository: VetRepository
  - DTO: Vets
  - Web: VetController
- org.springframework.samples.petclinic.system
  - CacheConfiguration (@EnableCaching; JCache "vets")
  - WebConfiguration (i18n: SessionLocaleResolver, LocaleChangeInterceptor "lang")
  - WelcomeController
  - CrashController

Key Configuration Defaults
- Actuator: expose all endpoints
- Static resource cache: max-age 12h
- Pagination defaults: 5 items/page for owners and vets
- Build/Runtime:
  - DB init via scripts; profiles switch DBs
  - Service binding for Postgres in Kubernetes (Secret type servicebinding.io/postgresql)
  - Docker Compose services (mysql:9.2, postgres:17.5 as specified)
  - Kubernetes: petclinic service NodePort 80→8080; liveness/readiness probes via /livez, /readyz

This consolidated summary preserves the complete set of components, APIs, data models, configuration, deployment details, validations, cross-cutting behaviors, and non-functional characteristics necessary to analyze and plan a microservice decomposition from the current Spring PetClinic monolith.